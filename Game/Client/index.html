<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <link href="client/main.css" rel="stylesheet"</link>
    </head>
    <body>
        <div id="game">
            <canvas id="ctx"></canvas>
            <div class="chat">
                <div class="messages">
                </div>
                <input class="chatinput"></input>
            </div>
        </div>
        <!--CHAT-->
        <script>
            var $chat = $('.chat'),
            $printer = $('.messages', $chat),
            $textArea = $('.chatinput', $chat),
            $postBtn = $('button', $chat),
            printerH = $printer.innerHeight(),
            preventNewScroll = false;

            $textArea.focus();

            //// SCROLL BOTTOM	
            function scrollBottom() {
                if (!preventNewScroll) { // if mouse is not over printer
                    $printer.stop().animate({ scrollTop: $printer[0].scrollHeight - printerH }, 600); // SET SCROLLER TO BOTTOM
                }
            }
            scrollBottom(); // DO IMMEDIATELY

            function postMessage(e) {
                // on Post click or 'enter' but allow new lines using shift+enter
                if (e.type == 'click' || (e.which == 13 && !e.shiftKey)) {
                    e.preventDefault();
                    var msg = $textArea.val(); // not empty / space
                    if ($.trim(msg)) {
                        $printer.append('<div>' + msg.replace(/\n/g, '<br>') + '</div>');
                        $textArea[0].value = ''; // CLEAR TEXTAREA
                        scrollBottom(); // DO ON POST
                        // HERE Use AJAX to post msg to PHP      
                    }
                }
            }


            //// PREVENT SCROLL TO BOTTOM WHILE READING OLD MESSAGES
            $printer.hover(function (e) {
                preventNewScroll = e.type == 'mouseenter' ? true : false;
                if (!preventNewScroll) { scrollBottom(); } // On mouseleave go to bottom
            });

            $postBtn.click(postMessage);
            $textArea.keyup(postMessage);
            $printer.append("<div>Welcome to Simon's Game Server</div>");
            //// TEST ONLY - SIMULATE NEW MESSAGES
            //var i = 0;
            //intv = setInterval(function () {
                //$printer.append("<div>Message ... " + (++i) + "</div>");
                //scrollBottom(); // DO ON NEW MESSAGE (AJAX)
            //}, 2000);

        </script>
        <!--GAME-->
        <script>
            var socket = io();
            var ctx = document.getElementById("ctx").getContext("2d");
            ctx.width = window.innerWidth;
            ctx.height = window.innerHeight;
            var sprite = {};
            sprite.player = new Image();
            sprite.player.src = '/client/sprites/warrior.png';
            sprite.grass1 = new Image();
            sprite.grass1.src = '/client/sprites/grass1.png';
            sprite.grass2 = new Image();
            sprite.grass2.src = '/client/sprites/grass2.png';
            sprite.rock1 = new Image();
            sprite.rock1.src = '/client/sprites/rock1.png';
            sprite.shrub1 = new Image();
            sprite.shrub1.src = '/client/sprites/shrub1.png';
            sprite.shrub2 = new Image();
            sprite.shrub2.src = '/client/sprites/shrub2.png';
            sprite.stump = new Image();
            sprite.stump.src = '/client/sprites/stump.png';
            sprite.tree1 = new Image();
            sprite.tree1.src = '/client/sprites/tree1.png';
            sprite.tree2 = new Image();
            sprite.tree2.src = '/client/sprites/tree2.png';
            sprite.tree3 = new Image();
            sprite.tree3.src = '/client/sprites/tree3.png';

            socket.on('positionalData', function (data) {
                ctx.clearRect(0, 0, ctx.width, ctx.height);
                for (var i = 0; i < data.length; i++) {
                    //map
                    for (var j = 0; j < data[i].map.length; j++) {
                        for (var k = 0; k < data[i].map[j].length; k++) {
                            if (data[i].map[j][k] == 0)
                                ctx.drawImage(sprite.grass1, k * 16, j * 16);
                            if (data[i].map[j][k] == 1)
                                ctx.drawImage(sprite.grass2, k * 16, j * 16);
                        }
                    }
                    //map overlays
                    for (var j = 0; j < data[i].mapoverlay.length; j++) {
                        for (var k = 0; k < data[i].mapoverlay[j].length; k++) {
                            if (data[i].mapoverlay[j][k] == 1)
                                ctx.drawImage(sprite.shrub1, k * 16, j * 16);
                            if (data[i].mapoverlay[j][k] == 2)
                                ctx.drawImage(sprite.shrub2, k * 16, j * 16);
                            if (data[i].mapoverlay[j][k] == 3)
                                ctx.drawImage(sprite.rock1, k * 16, j * 16);
                            if (data[i].mapoverlay[j][k] == 4)
                                ctx.drawImage(sprite.stump, k * 16, j * 16);
                            if (data[i].mapoverlay[j][k] == 5)
                                ctx.drawImage(sprite.tree1, k * 16, j * 16);
                            if (data[i].mapoverlay[j][k] == 6)
                                ctx.drawImage(sprite.tree2, k * 16, j * 16);
                            if (data[i].mapoverlay[j][k] == 7)
                                ctx.drawImage(sprite.tree3, k * 16, j * 16);
                        }
                    }
                    //player
                    if (data[i].spd == 0) {
                        if (data[i].dir == 'right')
                            ctx.drawImage(sprite.player, 0, 0, 16, 16, data[i].x, data[i].y, 16, 16);
                        else if (data[i].dir == 'left')
                            ctx.drawImage(sprite.player, 64, 0, 16, 16, data[i].x, data[i].y, 16, 16);
                    } else {
                        var pixels = 0;
                        if (data[i].dir == 'right'){
                            pixels = data[i].frame * 16;
                            ctx.drawImage(sprite.player, pixels, 0, 16, 16, data[i].x, data[i].y, 16, 16);
                        }
                        if (data[i].dir == 'left') {
                            pixels = (data[i].frame * 16) + 64;
                            ctx.drawImage(sprite.player, pixels, 0, 16, 16, data[i].x, data[i].y, 16, 16);
                        }
                    }
                }
            });


            //keydowns
            document.onkeydown = function (event) {
                if (event.keyCode === 87)
                    socket.emit('keypress', {
                        inputId: 'up',
                        state: true
                    });
                else if (event.keyCode === 83)
                    socket.emit('keypress', {
                        inputId: 'down',
                        state: true
                    });
                else if (event.keyCode === 65)
                    socket.emit('keypress', {
                        inputId: 'left',
                        state: true
                    });
                else if (event.keyCode === 68)
                    socket.emit('keypress', {
                        inputId: 'right',
                        state: true
                    });
            }

            //keyups
            document.onkeyup = function (event) {
                if (event.keyCode === 87)
                    socket.emit('keypress', {
                        inputId: 'up',
                        state: false,
                        spd: 0
                    });
                if (event.keyCode === 83)
                    socket.emit('keypress', {
                        inputId: 'down',
                        state: false,
                        spd: 0
                    });
                if (event.keyCode === 65)
                    socket.emit('keypress', {
                        inputId: 'left',
                        state: false,
                        spd: 0
                    });
                if (event.keyCode === 68)
                    socket.emit('keypress', {
                        inputId: 'right',
                        state: false,
                        spd: 0
                    });
            }
        </script>
    </body>
</html>