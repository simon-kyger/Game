<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <link href="client/main.css" rel="stylesheet"</link>
    </head>
    <body>
        <div id="game">
            <!--GAMEBOARD-->
            <canvas id="ctx"></canvas>
            <canvas id="ctx2"></canvas>
            <!--CHATUI-->
            <div id="chat" class="chat">
                <div id="messages" class="messages">
                    <div>Welcome to Simon's Game Server</div>
                </div>
                <input id="chatinput" class="chatinput"></input>
            </div>
            <div id="fps"></div>
            <!--ADDITIONALUI-->
        </div>
        <script>
            var socket = io();
            var chat = $('#chat');
            chat.printer = $('#messages', chat);
            chat.chatinput = $('#chatinput', chat);
            chat.height = chat.printer.height();
            chat.preventNewScroll = false;
            chat.scrollBottom = function() {
                if (!chat.preventNewScroll) { // if mouse is not over printer
                    chat.printer.stop().animate({
                        scrollTop: chat.printer[0].scrollHeight - chat.height
                    }, 600); // SET SCROLLER TO BOTTOM
                }
            }
            chat.scrollBottom();
            chat.postMessage = function (e) {
                // after hitting enter but allowing new lines using shift+enter
                if (e.which == 13 && !e.shiftKey) {
                    e.preventDefault();
                    var msg = chat.chatinput.val(); 
                    // not empty / space
                    if ($.trim(msg)) {
                        socket.emit('chatMsg', msg);
                    }
                }
            }
            chat.chatinput.keyup(chat.postMessage);
            // prevent scrolling when reading past messages
            chat.printer.hover(function (e) {
                if (e.type == 'mouseenter')
                    chat.preventNewScroll = true;
                else
                    chat.preventNewScroll = false;

                if (!chat.preventNewScroll) 
                    chat.scrollBottom(); // On mouseleave go to bottom
            });

            socket.on('addToChat', function (data) {
                chat.printer.append('<div>' + data.replace(/\n/g, '<br>') + '</div>');
                chat.chatinput[0].value = ''; // CLEAR TEXTAREA
                chat.scrollBottom();
            });

            //GAME
            var ctx = document.getElementById("ctx").getContext("2d");
            ctx.width = window.innerWidth;
            ctx.height = window.innerHeight;
            var WIDTH = ctx.width;
            var HEIGHT = ctx.height;
            var sprite = {};
            sprite.player = new Image();
            sprite.player.src = '/client/sprites/warrior.png';
            sprite.grass1 = new Image();
            sprite.grass1.src = '/client/sprites/grass1.png';
            sprite.grass2 = new Image();
            sprite.grass2.src = '/client/sprites/grass2.png';
            sprite.rock1 = new Image();
            sprite.rock1.src = '/client/sprites/rock1.png';
            sprite.shrub1 = new Image();
            sprite.shrub1.src = '/client/sprites/shrub1.png';
            sprite.shrub2 = new Image();
            sprite.shrub2.src = '/client/sprites/shrub2.png';
            sprite.stump = new Image();
            sprite.stump.src = '/client/sprites/stump.png';
            sprite.tree1 = new Image();
            sprite.tree1.src = '/client/sprites/tree1.png';
            sprite.tree2 = new Image();
            sprite.tree2.src = '/client/sprites/tree2.png';
            sprite.tree3 = new Image();
            sprite.tree3.src = '/client/sprites/tree3.png';
            var Player = function (init) {
                var self = {
                    id: init.id,
                    x: init.x,
                    y: init.y,
                    dirUp: init.dirUp,
                    dirDown: init.dirDown,
                    dirLeft: init.dirLeft,
                    dirRight: init.dirRight,
                    dir: init.dir,
                    spdx: init.spdx,
                    spdy: init.spdy,
                    frame: init.frame,
                    map: init.map,
                    mapOverlay: init.mapOverlay,
                    frame: init.frame,
                    mapx: null,
                    mapy: null,
                    pclass: init.pclass,
                }
                self.draw = function () {
                    var x = self.x - Player.list[selfId].x + window.innerWidth / 16 / 2;
                    var y = self.y - Player.list[selfId].y + window.innerHeight / 16 / 2;
                    if (self.spdy == 0 && self.spdx == 0) {
                        if (self.dir == 'right'){
                            ctx.drawImage(sprite.player, 0, 0, 16, 16, x, y, 16, 16);
                        }
                        if (self.dir == 'left'){
                            ctx.drawImage(sprite.player, 64, 0, 16, 16, x, y, 16, 16);
                        }
                    }
                    else {
                        var sourceoffset = Math.floor(self.frame) % 4;
                        if (self.dir == 'right') {
                            sourceoffset = sourceoffset * 16;
                            ctx.drawImage(sprite.player, sourceoffset, 0, 16, 16, x, y, 16, 16);
                        }
                        if (self.dir == 'left') {
                            sourceoffset = sourceoffset * 16 + 64;
                            ctx.drawImage(sprite.player, sourceoffset, 0, 16, 16, x, y, 16, 16);
                        }

                        self.frame+= .1;
                    }
                }
                Player.list[self.id] = self;
                return self;
            };
            //identification
            Player.list = {};

            //updates
            socket.on('init', function (data) {
                if (data.selfId !== undefined)
                    selfId = data.selfId;
                for (var i = 0; i < data.player.length; i++) {
                    new Player(data.player[i]);
                }
            });
            socket.on('update', function (data) {
                for (var i = 0; i < data.player.length; i++) {
                    var pack = data.player[i];
                    var p = Player.list[pack.id];
                    if (p) {
                        if (p.x !== undefined)
                            p.x = pack.x;
                        if (p.y !== undefined)
                            p.y = pack.y;
                        if (p.dir !== undefined)
                            p.dir = pack.dir;
                        if (p.spdy !== undefined)
                            p.spdy = pack.spdy;
                        if (p.spdx !== undefined)
                            p.spdx = pack.spdx;
                    }
                }
            });
            socket.on('remove', function (data) {
                for (var i = 0; i < data.player.length; i++)
                    delete Player.list[data.player[i]];
            });

            //game movement
            document.onkeydown = function (event) {
                if (event.keyCode === 87) {
                    socket.emit('keypress', {
                        inputId: 'up',
                        state: true
                    });
                }
                else if (event.keyCode === 83) {
                    socket.emit('keypress', {
                        inputId: 'down',
                        state: true
                    });
                }
                else if (event.keyCode === 65) {
                    socket.emit('keypress', {
                        inputId: 'left',
                        state: true
                    });
                }
                else if (event.keyCode === 68) {
                    socket.emit('keypress', {
                        inputId: 'right',
                        state: true
                    });
                }
            }
            document.onkeyup = function (event) {
                if (event.keyCode === 87) {
                    socket.emit('keypress', {
                        inputId: 'up',
                        state: false,
                    });
                }
                else if (event.keyCode === 83) {
                        socket.emit('keypress', {
                            inputId: 'down',
                            state: false,
                        });
                }
                else if (event.keyCode === 65) {
                        socket.emit('keypress', {
                            inputId: 'left',
                            state: false,
                        });
                }
                else if (event.keyCode === 68) {
                    socket.emit('keypress', {
                        inputId: 'right',
                        state: false,
                    });
                }
            }

            //rendering
            var TILEWIDTH = 16;
            var TILEHEIGHT = 16;
            function drawMap() {
                var p = Player.list[selfId];
                var map = p.map;
                var maparrw = p.map[0].length;
                var maparrh = p.map.length;
                var mapw = maparrw * TILEWIDTH;
                var maph = maparrh * TILEHEIGHT;
                for (var j = 0; j < maparrh; j++){
                    for(var k = 0; k < maparrw; k++){
                        if (map[j][k] == 0)
                            ctx.drawImage(sprite.grass1,0,0,TILEWIDTH,TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT)- p.y,TILEWIDTH,TILEHEIGHT);
                        if (map[j][k] == 1)
                            ctx.drawImage(sprite.grass2,0,0,TILEWIDTH,TILEHEIGHT, (k * TILEWIDTH)- p.x, (j * TILEHEIGHT) - p.y,TILEWIDTH,TILEHEIGHT);
                    }
                }
            }

            function drawMapOverlay() {
                var p = Player.list[selfId];
                var mv = p.mapOverlay;
                var mvw = p.mapOverlay[0].length;
                var mvh = p.mapOverlay.length;
                for (var j = 0; j < mvh; j++) {
                    for (var k = 0; k < mvw; k++) {
                        if (mv[j][k] == 1)
                            ctx.drawImage(sprite.shrub1, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                        if (mv[j][k] == 2)
                            ctx.drawImage(sprite.shrub2, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                        if (mv[j][k] == 3)
                            ctx.drawImage(sprite.rock1, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                        if (mv[j][k] == 4)
                            ctx.drawImage(sprite.stump, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                        if (mv[j][k] == 5)
                            ctx.drawImage(sprite.tree1, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                        if (mv[j][k] == 6)
                            ctx.drawImage(sprite.tree2, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                        if (mv[j][k] == 7)
                            ctx.drawImage(sprite.tree3, 0, 0, TILEWIDTH, TILEHEIGHT, (k * TILEWIDTH) - p.x, (j * TILEHEIGHT) / 2 - p.y, 16, 16);
                    }
                }
            }

            function drawPlayers() {
                for (var i in Player.list) {
                    Player.list[i].draw();
                }
            }
            function drawLighting() {
                var shadowCanvas = document.getElementById("ctx2");
                var shadowCtx = shadowCanvas.getContext('2d');
                shadowCanvas.width = ctx.width;
                shadowCanvas.height = ctx.height;

                // Make it black
                shadowCtx.fillStyle = '#000';
                shadowCtx.fillRect(0, 0, ctx.width, ctx.height);

                // Turn canvas into mask
                shadowCtx.globalCompositeOperation = "destination-out";

                // Light Source on player
                var x = WIDTH/2;
                var y = HEIGHT/2;
                gradient = shadowCtx.createRadialGradient(x, y, 1000, x, y, 100);
                gradient.addColorStop(0, "rgba(255, 255, 255, .1)");
                gradient.addColorStop(1, "rgba(255, 255, 255, 1.0)");
                shadowCtx.fillStyle = gradient;
                shadowCtx.fillRect(0, 0, ctx.width, ctx.height);
            }

            function render() {
                if (selfId == null)
                    return;
                ctx.clearRect(0, 0, ctx.width, ctx.height);
                drawMap();
                drawMapOverlay();
                drawPlayers();
                drawLighting();
            }
            var selfId;
             //game loop

            function init() {
                var previoustime = Date.now();
                var frames = 0;
                function main(time) {
                    render();
                    frames++;
                    while (Date.now() - previoustime > 1000) {
                        $('#fps').html('FPS:' + frames);
                        previoustime += 1000;
                        frames = 0;
                    }
                    requestAnimationFrame(main);
                }
                requestAnimationFrame(main);
            }
            window.onload = init;


        </script>
    </body>
</html>